name: Discord Bot Manager

on:
  workflow_dispatch:
    inputs:
      botId:
        required: true
        description: 'Bot ID to send'
        type: string
      title:
        required: true
        description: 'Post title (forum thread name)'
        type: string
      message:
        required: true
        description: 'Message content'
        type: string
      scheduled:
        required: false
        description: 'Is this a scheduled post?'
        default: 'false'
        type: string

env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  DISCORD_AVATAR_URL: ${{ secrets.DISCORD_AVATAR_URL || 'https://github.com/simplyIeaf.png' }}
  DISCORD_USERNAME: ${{ secrets.DISCORD_USERNAME || 'Leaf\'s Scripts' }}

jobs:
  check-scheduled-posts:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ env.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: pip install requests

      - name: Check and send scheduled posts
        id: check-scheduled
        run: |
          python3 << 'EOF'
          import json
          import os
          from datetime import datetime, timezone
          import subprocess
          import sys
          
          # Load database
          with open('database.json', 'r') as f:
              data = json.load(f)
          
          now = datetime.now(timezone.utc)
          sent_bots = []
          
          for bot_id, bot in data.get('bots', {}).items():
              # Check if scheduled, not sent, not cancelled, and time has arrived
              if (bot.get('scheduled') and 
                  not bot.get('sent', False) and 
                  not bot.get('cancelled', False) and
                  bot.get('scheduledTime')):
                  
                  scheduled_time_str = bot['scheduledTime']
                  if scheduled_time_str.endswith('Z'):
                      scheduled_time_str = scheduled_time_str[:-1] + '+00:00'
                  
                  scheduled_time = datetime.fromisoformat(scheduled_time_str)
                  
                  # Check if scheduled time has passed (within 5 minute window)
                  time_diff = (scheduled_time - now).total_seconds()
                  
                  if -300 <= time_diff <= 0:  # Within 5 minutes after scheduled time
                      print(f"Triggering bot: {bot_id} - {bot['title']}")
                      
                      # Trigger the send job via curl
                      import subprocess
                      import json as json_module
                      
                      repo = os.environ['GITHUB_REPOSITORY']
                      
                      payload = json_module.dumps({
                          'ref': 'main',
                          'inputs': {
                              'botId': bot_id,
                              'title': bot['title'],
                              'message': bot['message'],
                              'scheduled': 'true'
                          }
                      })
                      
                      curl_cmd = [
                          'curl', '-X', 'POST',
                          '-H', 'Authorization: Bearer ' + os.environ['GITHUB_TOKEN'],
                          '-H', 'Accept: application/vnd.github.v3+json',
                          '-H', 'Content-Type: application/json',
                          'https://api.github.com/repos/' + repo + '/actions/workflows/discord_bot.yml/dispatches',
                          '-d', payload
                      ]
                      
                      try:
                          result = subprocess.run(curl_cmd, capture_output=True, text=True)
                          if result.returncode == 0:
                              print(f"Successfully triggered bot {bot_id}")
                              sent_bots.append(bot_id)
                          else:
                              print(f"Failed to trigger bot {bot_id}: {result.stderr}")
                      except Exception as e:
                          print(f"Error triggering bot {bot_id}: {e}")
          
          if sent_bots:
              print(f"Triggered {len(sent_bots)} scheduled bots")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"triggered_bots={','.join(sent_bots)}\n")
          EOF

  send-discord-post:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ env.GITHUB_TOKEN }}

      - name: Setup Python and jq
        run: |
          python -m pip install --upgrade pip
          sudo apt-get update && sudo apt-get install -y jq curl

      - name: Load and validate bot data
        id: load-bot
        run: |
          if [ ! -f "database.json" ]; then
            echo '{"scripts": {}, "bots": {}}' > database.json
          fi
          
          python3 << 'EOF'
          import json, sys, os
          
          with open('database.json', 'r') as f:
              data = json.load(f)
          
          # Get bot ID from GitHub Actions input
          bot_id = os.environ.get('INPUT_BOTID', '${{ github.event.inputs.botId }}')
          print(f"Looking for bot ID: {bot_id}")
          
          if not bot_id or bot_id == '${{ github.event.inputs.botId }}':
              print("ERROR: No bot ID provided")
              sys.exit(1)
          
          if bot_id not in data.get('bots', {}):
              print(f"ERROR: Bot {bot_id} not found in database")
              print(f"Available bots: {list(data.get('bots', {}).keys())}")
              sys.exit(1)
          
          bot = data['bots'][bot_id]
          print(f"Found bot: {bot['title']}")
          
          # Prevent duplicate sends
          if bot.get('sent', False):
              print(f"INFO: Bot {bot_id} already sent")
              sys.exit(0)
          
          if bot.get('cancelled', False):
              print(f"INFO: Bot {bot_id} is cancelled")
              sys.exit(0)
          
          print(f"Processing bot: {bot['title']}")
          EOF

      - name: Create Discord forum post
        id: discord-post
        env:
          BOT_TITLE: "${{ github.event.inputs.title }}"
          BOT_MESSAGE: "${{ github.event.inputs.message }}"
        run: |
          # Debug info
          echo "=== DISCORD CONFIG ==="
          echo "Avatar URL: $DISCORD_AVATAR_URL"
          echo "Username: $DISCORD_USERNAME"
          echo "Bot Title: $BOT_TITLE"
          echo "======================"
          
          # Escape JSON properly
          ESCAPED_TITLE=$(echo "$BOT_TITLE" | jq -R . 2>/dev/null || echo "\"$BOT_TITLE\"")
          ESCAPED_MESSAGE=$(echo "$BOT_MESSAGE" | jq -R . 2>/dev/null || echo "\"$BOT_MESSAGE\"")
          ESCAPED_USERNAME=$(echo "$DISCORD_USERNAME" | jq -R . 2>/dev/null || echo "\"$DISCORD_USERNAME\"")
          
          # Discord forum post payload with customizable avatar and username
          PAYLOAD=$(cat <<EOF
          {
            "content": $ESCAPED_MESSAGE,
            "username": $ESCAPED_USERNAME,
            "avatar_url": "$DISCORD_AVATAR_URL",
            "thread_name": $ESCAPED_TITLE
          }
          EOF
          )
          
          echo "Sending to Discord webhook..."
          
          # Send to Discord webhook
          HTTP_CODE=$(curl -s -o /tmp/discord_response.txt -w "%{http_code}" \
            -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")
          
          RESPONSE=$(cat /tmp/discord_response.txt)
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 204 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            # Extract thread ID if available
            THREAD_ID=$(echo "$RESPONSE" | jq -r '.id // empty' 2>/dev/null || echo "")
            if [ -n "$THREAD_ID" ] && [ "$THREAD_ID" != "null" ]; then
              echo "thread_id=$THREAD_ID" >> $GITHUB_OUTPUT
              echo "Thread created with ID: $THREAD_ID"
            fi
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "ERROR: Discord API error: $HTTP_CODE"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: Update database with sent status
        if: steps.discord-post.outputs.status == 'success'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          THREAD_ID="${{ steps.discord-post.outputs.thread_id }}"
          
          python3 << 'EOF'
          import json, sys, os
          
          with open('database.json', 'r') as f:
              data = json.load(f)
          
          bot_id = '${{ github.event.inputs.botId }}'
          print(f"Updating bot: {bot_id}")
          
          if bot_id not in data.get('bots', {}):
              print(f"ERROR: Bot {bot_id} not found in database")
              sys.exit(1)
          
          bot = data['bots'][bot_id]
          bot['sent'] = True
          bot['sentTime'] = '$TIMESTAMP'
          bot['status'] = 'sent'
          bot['scheduled'] = False
          
          thread_id = '$THREAD_ID'
          if thread_id and thread_id != 'null' and thread_id != 'empty':
              bot['threadId'] = thread_id
          
          # Save to file
          with open('database.json', 'w') as f:
              json.dump(data, f, indent=2, ensure_ascii=False)
          
          print(f"Database updated successfully for bot {bot_id}")
          print(f"Bot status: sent at {bot['sentTime']}")
          EOF

      - name: Commit and push database changes
        if: steps.discord-post.outputs.status == 'success'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add database.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update bot: ${{ github.event.inputs.botId }} - sent at $(date -u +'%Y-%m-%d %H:%M:%S')"
            git push
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "=== WORKFLOW FAILED ==="
          echo "Bot ID: ${{ github.event.inputs.botId }}"
          echo "Title: ${{ github.event.inputs.title }}"
          echo "Check:"
          echo "1. Discord webhook URL is set as secret"
          echo "2. Bot exists in database.json"
          echo "3. Bot is not already sent or cancelled"
          echo "========================"
