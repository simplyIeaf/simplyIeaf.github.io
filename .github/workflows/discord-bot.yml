name: Discord Bot Manager
on:
  workflow_dispatch:
    inputs:
      botId:
        description: 'Bot ID'
        required: true
      title:
        description: 'Post title'
        required: true
      message:
        description: 'Post message'
        required: true

jobs:
  send-discord-post:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create and run Python script
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          cat > script.py << 'PYSCRIPT'
          import json
          import datetime
          import urllib.request
          import urllib.error
          
          bot_id = '${{ github.event.inputs.botId }}'
          title = '${{ github.event.inputs.title }}'
          message = '''${{ github.event.inputs.message }}'''
          webhook_url = '${{ secrets.DISCORD_WEBHOOK }}'
          
          timestamp = datetime.datetime.utcnow().isoformat() + 'Z'
          
          try:
              with open('database.json', 'r') as f:
                  data = json.load(f)
          except FileNotFoundError:
              data = {'scripts': {}, 'bots': {}}
          
          if 'bots' not in data:
              data['bots'] = {}
          
          if bot_id in data['bots']:
              data['bots'][bot_id]['sent'] = True
              data['bots'][bot_id]['sentTime'] = timestamp
              data['bots'][bot_id]['status'] = 'sent'
              data['bots'][bot_id]['scheduled'] = False
          
          with open('database.json', 'w') as f:
              json.dump(data, f, indent=2)
          
          print('Database updated')
          
          discord_payload = {
              'content': message,
              'thread_name': title,
              'username': "Leaf's Helper",
              'avatar_url': 'https://github.com/simplyIeaf.png'
          }
          
          try:
              req = urllib.request.Request(
                  webhook_url,
                  data=json.dumps(discord_payload).encode('utf-8'),
                  headers={'Content-Type': 'application/json'}
              )
              
              with urllib.request.urlopen(req) as response:
                  if response.status in [200, 204]:
                      print('Discord post sent successfully')
                  else:
                      print(f'Status: {response.status}')
          except urllib.error.HTTPError as e:
              print(f'HTTP Error: {e.code} - {e.reason}')
          except Exception as e:
              print(f'Error: {e}')
          PYSCRIPT
          
          python3 script.py
          
      - name: Commit changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git fetch origin
          git pull origin main
          
          git add database.json
          
          if ! git diff --staged --quiet; then
            git commit -m "Update bot status: ${{ github.event.inputs.botId }}"
            git push origin main
            echo "Changes committed"
          fi
