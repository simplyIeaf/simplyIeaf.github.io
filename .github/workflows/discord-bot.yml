name: Discord Bot Manager
on:
  workflow_dispatch:
    inputs:
      botId:
        required: true
      title:
        required: true
      message:
        required: true
      scheduled:
        default: 'false'
jobs:
  send-discord-post:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup database
        run: |
          if [ ! -f "database.json" ]; then
            echo '{"scripts": {}, "bots": {}}' > database.json
          fi
      - name: Send Discord post
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"${{ github.event.inputs.message }}\",
              \"thread_name\": \"${{ github.event.inputs.title }}\",
              \"avatar_url\": \"https://avatars.githubusercontent.com/u/220599690?v=4\",
              \"username\": \"Leaf's Helper\"
            }"
      - name: Update database for scheduled posts
        if: github.event.inputs.scheduled == 'true'
        run: |
          BOT_ID="${{ github.event.inputs.botId }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          python3 -c "
          import json
          with open('database.json', 'r') as f:
            data = json.load(f)
          if '$BOT_ID' in data.get('bots', {}):
            data['bots']['$BOT_ID']['sent'] = True
            data['bots']['$BOT_ID']['sentTime'] = '$TIMESTAMP'
            data['bots']['$BOT_ID']['status'] = 'sent'
          with open('database.json', 'w') as f:
            json.dump(data, f, indent=2)
          "
      - name: Commit database changes
        if: github.event.inputs.scheduled == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add database.json
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "Update bot: ${{ github.event.inputs.botId }}"
            git push
          fi
