name: Discord Bot Webhook

on:
  workflow_dispatch:
    inputs:
      botId:
        description: 'ID of the bot'
        required: true
      title:
        description: 'Title of the post'
        required: true
      message:
        description: 'Message content'
        required: true
      scheduled:
        description: 'Whether it was a scheduled post'
        required: true
        default: 'false'

jobs:
  post-to-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Send Webhook to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          STATUS_MSG="üöÄ Manual Trigger"
          if [ "${{ github.event.inputs.scheduled }}" == "true" ]; then
            STATUS_MSG="‚è∞ Scheduled Trigger"
          fi
          
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "'"${{ github.event.inputs.title }}"'",
                   "description": "'"${{ github.event.inputs.message }}"'",
                   "footer": { "text": "'"$STATUS_MSG"'" },
                   "color": 5814783
                 }]
               }' \
               $DISCORD_WEBHOOK_URL

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Database Status
        run: |
          # Use node to safely update the JSON file
          node -e "
          const fs = require('fs');
          const db = JSON.parse(fs.readFileSync('database.json', 'utf8'));
          const botId = '${{ github.event.inputs.botId }}';
          if (db.bots[botId]) {
            db.bots[botId].sent = true;
            db.bots[botId].status = 'sent';
            db.bots[botId].sentTime = new Date().toISOString();
          }
          fs.writeFileSync('database.json', JSON.stringify(db, null, 2));
          "
          
      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check if there are actual changes in database.json
          git add database.json
          
          if git diff --cached --quiet; then
            echo "No changes detected in database.json. Skipping commit."
          else
            echo "Changes detected. Committing..."
            git commit -m "Automated: Bot ${{ github.event.inputs.botId }} marked as sent"
            git push origin main
          fi
