name: Discord Bot Webhook

on:
  workflow_dispatch:
    inputs:
      botId:
        description: 'ID of the bot to send'
        required: false
      title:
        description: 'Post Title'
        required: false
      message:
        description: 'Post Message'
        required: false
      scheduled:
        description: 'Triggered from schedule'
        required: false
        default: 'false'
  schedule:
    - cron: '*/2 * * * *'

jobs:
  process-bot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Process and Send Webhook
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          node -e "
          const fs = require('fs');
          const https = require('https');

          async function postToDiscord(title, message) {
            return new Promise((resolve, reject) => {
              const url = new URL(process.env.WEBHOOK_URL);
              const data = JSON.stringify({
                thread_name: title,
                content: message
              });

              const options = {
                hostname: url.hostname,
                path: url.pathname + url.search,
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': Buffer.byteLength(data)
                }
              };

              const req = https.request(options, (res) => {
                res.on('data', () => {});
                res.on('end', () => resolve());
              });
              
              req.on('error', (e) => reject(e));
              req.write(data);
              req.end();
            });
          }

          async function run() {
            if (!fs.existsSync('database.json')) {
              console.error('database.json not found');
              process.exit(1);
            }

            const db = JSON.parse(fs.readFileSync('database.json', 'utf8'));
            const now = new Date();
            let hasChanges = false;
            
            const inputBotId = '${{ github.event.inputs.botId }}';
            const inputTitle = '${{ github.event.inputs.title }}';
            const inputMsg = '${{ github.event.inputs.message }}';

            if (inputTitle && inputMsg) {
              await postToDiscord(inputTitle, inputMsg);
              if (inputBotId && db.bots[inputBotId]) {
                db.bots[inputBotId].sent = true;
                db.bots[inputBotId].status = 'sent';
                db.bots[inputBotId].sentTime = new Date().toISOString();
                db.bots[inputBotId].scheduled = false;
                hasChanges = true;
              }
            } 
            
            for (const [id, bot] of Object.entries(db.bots || {})) {
              if (bot.scheduled && !bot.sent && !bot.cancelled) {
                const scheduledTime = new Date(bot.scheduledTime);
                if (scheduledTime <= now) {
                  try {
                    await postToDiscord(bot.title, bot.message);
                    bot.sent = true;
                    bot.status = 'sent';
                    bot.sentTime = new Date().toISOString();
                    bot.scheduled = false;
                    hasChanges = true;
                    await new Promise(r => setTimeout(r, 1000));
                  } catch (err) {
                    console.error('Error sending ' + id + ':', err);
                  }
                }
              }
            }

            if (hasChanges) {
              fs.writeFileSync('database.json', JSON.stringify(db, null, 2));
            }
          }

          run();
          "

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add database.json
          
          if git diff --cached --quiet; then
            echo "No changes detected."
          else
            git commit -m "Automated: Bot status sync [$(date)]"
            git pull origin main --rebase -X theirs
            git push origin main
          fi
