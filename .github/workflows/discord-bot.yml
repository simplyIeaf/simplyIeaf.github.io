name: Discord Bot Webhook

on:
  workflow_dispatch:
    inputs:
      botId:
        description: 'ID of the bot to send manually'
        required: false
      title:
        description: 'Post Title'
        required: false
      message:
        description: 'Post Message'
        required: false
  schedule:
    - cron: '*/5 * * * *'

jobs:
  process-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Process Bots
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node -e "
          const fs = require('fs');
          const https = require('https');

          async function postToDiscord(title, message, botId) {
            return new Promise((resolve) => {
              try {
                const url = new URL(process.env.WEBHOOK_URL);
                const payload = {
                  content: \`**\${title}**\\n\\n\${message}\`,
                  thread_name: title,
                  allowed_mentions: { parse: [] }
                };

                const data = JSON.stringify(payload);
                const options = {
                  hostname: url.hostname,
                  path: url.pathname + url.search,
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': Buffer.byteLength(data)
                  },
                  timeout: 10000
                };

                const req = https.request(options, (res) => {
                  let responseData = '';
                  res.on('data', (chunk) => responseData += chunk);
                  res.on('end', () => {
                    if (res.statusCode >= 200 && res.statusCode < 300) {
                      console.log(\`✅ Sent: \${title}\`);
                      resolve({ success: true, botId });
                    } else {
                      console.error(\`❌ API Error (\${res.statusCode}): \${responseData}\`);
                      resolve({ success: false, error: responseData, botId });
                    }
                  });
                });
                
                req.on('error', (e) => resolve({ success: false, error: e.message, botId }));
                req.on('timeout', () => { req.destroy(); resolve({ success: false, error: 'Timeout', botId }); });
                req.write(data);
                req.end();
              } catch (error) {
                resolve({ success: false, error: error.message, botId });
              }
            });
          }

          async function run() {
            try {
              if (!fs.existsSync('database.json')) return;

              const db = JSON.parse(fs.readFileSync('database.json', 'utf8'));
              const now = new Date();
              let hasChanges = false;
              
              const manualBotId = '${{ github.event.inputs.botId }}';
              
              if (manualBotId && db.bots && db.bots[manualBotId]) {
                 console.log(\`Manual trigger for: \${manualBotId}\`);
                 const bot = db.bots[manualBotId];
                 const result = await postToDiscord(bot.title, bot.message, manualBotId);
                 if (result.success) {
                   bot.sent = true;
                   bot.status = 'sent';
                   bot.sentTime = now.toISOString();
                   bot.scheduled = false;
                   hasChanges = true;
                 }
              }

              if (db.bots) {
                for (const [botId, bot] of Object.entries(db.bots)) {
                  if (bot.sent || bot.cancelled || bot.isProcessing) continue;
                  
                  if (bot.scheduled && bot.scheduledTime) {
                    const scheduledTime = new Date(bot.scheduledTime);
                    
                    if (scheduledTime <= now) {
                      console.log(\`Processing scheduled bot: \${bot.title}\`);
                      bot.isProcessing = true;
                      
                      const result = await postToDiscord(bot.title, bot.message, botId);
                      
                      if (result.success) {
                        bot.sent = true;
                        bot.status = 'sent';
                        bot.sentTime = now.toISOString();
                        bot.scheduled = false;
                      } else {
                        bot.lastError = result.error;
                        bot.errorCount = (bot.errorCount || 0) + 1;
                        if (bot.errorCount >= 5) bot.scheduled = false;
                      }
                      
                      bot.isProcessing = false;
                      bot.lastAttempt = now.toISOString();
                      hasChanges = true;
                      
                      await new Promise(r => setTimeout(r, 1000));
                    }
                  }
                }
              }

              if (hasChanges) {
                fs.writeFileSync('database.json', JSON.stringify(db, null, 2));
              }
            } catch (error) {
              console.error('Script Error:', error);
              process.exit(1);
            }
          }

          run();
          "

      - name: Commit Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add database.json
          if ! git diff --staged --quiet; then
            git commit -m "Bot: Update status [skip ci]"
            git pull origin main --rebase
            git push origin main
          fi
